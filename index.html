<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>URL Redirector | Netlify & Firestore</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .gradient-bg { background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); }
        .card { background-color: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2); }
        .btn-primary { background-color: #4f46e5; transition: background-color 0.3s ease; }
        .btn-primary:hover { background-color: #4338ca; }
        .input-focus:focus { box-shadow: 0 0 0 2px #4f46e5; border-color: #4f46e5; }
        .log-table th { @apply px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider; }
        .log-table td { @apply px-4 py-3 whitespace-nowrap text-sm text-gray-700; }
        .modal-overlay { transition: opacity 0.3s ease; }
        .modal-content { transition: transform 0.3s ease; }
    </style>
</head>
<body class="gradient-bg min-h-screen flex items-center justify-center p-4">

    <div class="w-full max-w-4xl mx-auto">
        <div class="card rounded-2xl shadow-2xl p-6 md:p-10">
            <div class="text-center mb-8">
                <h1 class="text-3xl md:text-4xl font-bold text-gray-800">URL Redirector</h1>
                <p class="text-gray-500 mt-2">Create, manage, and analyze your short links.</p>
                <p class="text-xs text-gray-400 mt-1">Your User ID: <span id="userId" class="font-mono">loading...</span></p>
            </div>

            <!-- View Toggles -->
            <div class="flex justify-center border-b border-gray-200 mb-6">
                <button id="show-links-btn" class="px-4 py-2 -mb-px border-b-2 border-indigo-500 text-indigo-600 font-semibold">Manage Links</button>
                <button id="show-analytics-btn" class="px-4 py-2 text-gray-500 font-semibold hover:text-indigo-600">Analytics</button>
            </div>

            <!-- Main Content Area -->
            <div id="main-content">
                <!-- Links Management View -->
                <div id="links-view">
                    <!-- Form to create a new link -->
                    <div id="create-section">
                        <h2 class="text-xl font-semibold text-gray-700 mb-4">Create a New Short Link</h2>
                        <form id="create-link-form" class="space-y-4">
                           <div>
                                <label for="longUrl" class="block text-sm font-medium text-gray-600 mb-1">Original URL</label>
                                <input type="url" id="longUrl" placeholder="https://your-long-url.com" required
                                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none input-focus transition-shadow">
                            </div>
                            <div>
                                <label for="customSlug" class="block text-sm font-medium text-gray-600 mb-1">Custom Slug (Optional)</label>
                                <div class="flex">
                                   <span class="inline-flex items-center px-3 text-sm text-gray-500 bg-gray-100 border border-r-0 border-gray-300 rounded-l-md">
                                        <span id="base-url">your-site.netlify.app/</span>
                                   </span>
                                   <input type="text" id="customSlug" placeholder="my-custom-link"
                                          class="w-full px-4 py-2 border border-gray-300 rounded-r-lg focus:outline-none input-focus transition-shadow"
                                          pattern="[a-zA-Z0-9-]+" title="Only letters, numbers, and hyphens are allowed.">
                                </div>
                            </div>
                            <button type="submit" id="submit-btn" class="w-full btn-primary text-white font-semibold py-2.5 px-4 rounded-lg shadow-md">
                                <span id="btn-text">Shorten URL</span>
                                <span id="btn-loader" class="hidden">
                                    <svg class="animate-spin h-5 w-5 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                    </svg>
                                </span>
                            </button>
                        </form>
                    </div>

                    <!-- Display generated link -->
                    <div id="result-section" class="hidden mt-6 text-center p-4 bg-indigo-50 rounded-lg border border-indigo-200">
                        <p class="text-gray-700">Your short link is ready!</p>
                        <div class="flex items-center justify-center mt-2">
                            <a id="short-link" href="#" target="_blank" class="text-indigo-600 font-mono text-lg hover:underline"></a>
                            <button id="copy-btn" class="ml-4 p-2 text-gray-500 hover:text-indigo-600 rounded-full hover:bg-indigo-100 transition">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
                            </button>
                        </div>
                        <p id="copy-feedback" class="text-sm text-green-600 mt-1 h-4"></p>
                    </div>

                    <!-- Message box for errors or info -->
                    <div id="message-box" class="hidden mt-4 p-3 text-center text-sm rounded-lg"></div>

                    <!-- List of existing links -->
                    <div class="mt-10">
                        <h2 class="text-xl font-semibold text-gray-700 mb-4">Your Links</h2>
                        <div id="links-container" class="space-y-3">
                            <p id="no-links-msg" class="text-gray-500 text-center py-4">You haven't created any links yet.</p>
                            <div id="links-loader" class="text-center py-4">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Analytics View -->
                <div id="analytics-view" class="hidden">
                    <h2 class="text-xl font-semibold text-gray-700 mb-4">Click Analytics</h2>
                    <div class="overflow-x-auto bg-white rounded-lg shadow">
                       <table class="min-w-full divide-y divide-gray-200 log-table">
                           <thead class="bg-gray-50">
                               <tr>
                                   <th>Timestamp</th>
                                   <th>Slug</th>
                                   <th>Country</th>
                                   <th>Referrer</th>
                                   <th>Details</th>
                               </tr>
                           </thead>
                           <tbody id="logs-container" class="divide-y divide-gray-200">
                           </tbody>
                       </table>
                    </div>
                     <p id="no-logs-msg" class="hidden text-gray-500 text-center py-8">No click data available yet.</p>
                     <div id="logs-loader" class="text-center py-8">
                        <svg class="animate-spin h-8 w-8 text-indigo-500 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                     </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Log Details Modal -->
    <div id="log-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden">
        <div id="modal-overlay" class="modal-overlay absolute inset-0 bg-black bg-opacity-50"></div>
        <div id="modal-content" class="modal-content bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-full overflow-y-auto transform scale-95">
            <div class="p-6">
                <div class="flex justify-between items-center border-b pb-3">
                    <h3 class="text-xl font-semibold text-gray-800">Log Details</h3>
                    <button id="close-modal-btn" class="p-2 rounded-full hover:bg-gray-200">
                        <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>
                <div class="mt-4">
                    <pre id="log-details-content" class="text-sm bg-gray-100 p-4 rounded-md overflow-x-auto"></pre>
                </div>
            </div>
        </div>
    </div>


    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, onSnapshot, deleteDoc, setLogLevel, query, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Configuration and Initialization ---
        // ** FIX: The config is now placed directly inside this script to prevent loading issues. **
        const firebaseConfig = {
            apiKey: "AIzaSyCc2Em_b5oe1bGtQzcAlhYzqSnlAGfQt-0",
            authDomain: "guegxredir.firebaseapp.com",
            projectId: "guegxredir",
            storageBucket: "guegxredir.firebasestorage.app",
            messagingSenderId: "1086770860900",
            appId: "1:1086770860900:web:929a76665e66a5e36f6071",
            measurementId: "G-4FLDMRLXVN"
        };
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, db, auth, currentUserId;
        let logsUnsubscribe = null; 

        // --- UI Element References ---
        const showLinksBtn = document.getElementById('show-links-btn');
        const showAnalyticsBtn = document.getElementById('show-analytics-btn');
        const linksView = document.getElementById('links-view');
        const analyticsView = document.getElementById('analytics-view');
        const logsContainer = document.getElementById('logs-container');
        const noLogsMsg = document.getElementById('no-logs-msg');
        const logsLoader = document.getElementById('logs-loader');
        const logModal = document.getElementById('log-modal');
        const modalOverlay = document.getElementById('modal-overlay');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const logDetailsContent = document.getElementById('log-details-content');
        const createLinkForm = document.getElementById('create-link-form');
        const longUrlInput = document.getElementById('longUrl');
        const customSlugInput = document.getElementById('customSlug');
        const submitBtn = document.getElementById('submit-btn');
        const btnText = document.getElementById('btn-text');
        const btnLoader = document.getElementById('btn-loader');
        const resultSection = document.getElementById('result-section');
        const shortLinkEl = document.getElementById('short-link');
        const copyBtn = document.getElementById('copy-btn');
        const copyFeedback = document.getElementById('copy-feedback');
        const messageBox = document.getElementById('message-box');
        const linksContainer = document.getElementById('links-container');
        const noLinksMsg = document.getElementById('no-links-msg');
        const linksLoader = document.getElementById('links-loader');
        const userIdSpan = document.getElementById('userId');
        const baseUrlSpan = document.getElementById('base-url');

        // --- Main Application Logic ---

        async function initializeFirebase() {
            if (!firebaseConfig.apiKey) {
                console.error("Firebase config is missing.");
                showMessage("Configuration error. App cannot start.", "error");
                return;
            }
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('debug');
                setupAuthListener();
            } catch (error) {
                console.error("Firebase initialization failed:", error);
                showMessage("Failed to initialize the application.", "error");
            }
        }

        function setupAuthListener() {
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    currentUserId = user.uid;
                    userIdSpan.textContent = currentUserId;
                    console.log("User is signed in with UID:", currentUserId);
                    await setupRealtimeListeners();
                } else {
                    console.log("User is not signed in. Attempting to sign in.");
                    await signIn();
                }
            });
        }
        
        async function signIn() {
             try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                    console.log("Signed in with custom token.");
                } else {
                    await signInAnonymously(auth);
                    console.log("Signed in anonymously.");
                }
            } catch (error) {
                console.error("Authentication failed:", error);
                showMessage(error.message, "error");
            }
        }

        async function setupRealtimeListeners() {
            if (!currentUserId) return;
            
            const linksCollectionPath = `/artifacts/${appId}/users/${currentUserId}/redirects`;
            onSnapshot(collection(db, linksCollectionPath), (snapshot) => {
                linksLoader.classList.add('hidden');
                noLinksMsg.classList.toggle('hidden', !snapshot.empty);
                displayLinks(snapshot.docs);
            }, (error) => {
                console.error("Error fetching links:", error);
                showMessage("Could not load your links.", "error");
            });

            const logsCollectionPath = `/artifacts/${appId}/users/${currentUserId}/logs`;
            const logsQuery = query(collection(db, logsCollectionPath), orderBy('timestamp', 'desc'));

            if (logsUnsubscribe) logsUnsubscribe(); 
            
            logsUnsubscribe = onSnapshot(logsQuery, (snapshot) => {
                logsLoader.classList.add('hidden');
                noLogsMsg.classList.toggle('hidden', !snapshot.empty);
                displayLogs(snapshot.docs);
            }, (error) => {
                console.error("Error fetching logs:", error);
                showMessage("Could not load analytics data.", "error");
            });
        }

        function displayLinks(docs) {
            const docMap = new Map(docs.map(doc => [doc.id, doc.data()]));
            const linkItems = linksContainer.querySelectorAll('.link-item');

            linkItems.forEach(item => {
                if (!docMap.has(item.dataset.slug)) item.remove();
            });

            docMap.forEach((data, slug) => {
                let linkItem = linksContainer.querySelector(`.link-item[data-slug="${slug}"]`);
                if (!linkItem) {
                    linkItem = document.createElement('div');
                    linkItem.className = 'link-item flex items-center justify-between p-3 bg-white border rounded-lg shadow-sm';
                    linkItem.dataset.slug = slug;
                    linksContainer.appendChild(linkItem);
                }
                const shortUrl = `${window.location.origin}/${slug}`;
                linkItem.innerHTML = `
                    <div class="flex-grow overflow-hidden mr-4">
                        <a href="${shortUrl}" target="_blank" class="font-semibold text-indigo-700 truncate hover:underline">${shortUrl}</a>
                        <p class="text-sm text-gray-500 truncate" title="${data.longUrl}">${data.longUrl}</p>
                    </div>
                    <div class="flex-shrink-0 flex items-center space-x-2">
                        <span class="text-sm font-medium text-gray-600">${data.clickCount || 0} Clicks</span>
                        <button class="delete-btn p-2 text-gray-400 hover:text-red-600 hover:bg-red-100 rounded-full transition" data-slug="${slug}">
                             <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        </button>
                    </div>
                `;
            });
        }

        function displayLogs(docs) {
            logsContainer.innerHTML = '';
            if (docs.length === 0) return;

            docs.forEach(doc => {
                const logData = doc.data();
                const tr = document.createElement('tr');
                tr.className = "hover:bg-gray-50";
                
                const formattedDate = new Date(logData.timestamp).toLocaleString();

                tr.innerHTML = `
                    <td>${formattedDate}</td>
                    <td>/${logData.slug}</td>
                    <td>${logData.geolocation?.country || 'N/A'}</td>
                    <td class="truncate max-w-xs">${logData.referrer || 'Direct'}</td>
                    <td>
                        <button class="view-log-details-btn text-indigo-600 hover:text-indigo-900 font-medium" data-log-id="${doc.id}">
                            View
                        </button>
                    </td>
                `;
                tr.querySelector('.view-log-details-btn')._logData = logData;
                logsContainer.appendChild(tr);
            });
        }

        async function handleCreateLink(e) {
            e.preventDefault();
            setLoading(true);

            const longUrl = longUrlInput.value;
            const customSlug = customSlugInput.value.trim();

            try {
                const response = await fetch('/.netlify/functions/create-link', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ longUrl, customSlug, userId: currentUserId, appId }),
                });
                const data = await response.json();
                if (!response.ok) throw new Error(data.error || 'An error occurred.');

                const fullShortUrl = `${window.location.origin}/${data.slug}`;
                shortLinkEl.href = fullShortUrl;
                shortLinkEl.textContent = fullShortUrl;
                resultSection.classList.remove('hidden');
                showMessage(`Successfully created link!`, 'success');
                createLinkForm.reset();
            } catch (error) {
                console.error('Error creating link:', error);
                showMessage(error.message, 'error');
            } finally {
                setLoading(false);
            }
        }

        async function handleDeleteLink(e) {
             if (e.target.closest('.delete-btn')) {
                const button = e.target.closest('.delete-btn');
                const slug = button.dataset.slug;
                
                if (window.confirm(`Are you sure you want to delete the link for "${slug}"? This action cannot be undone.`)) {
                    try {
                        const docPath = `/artifacts/${appId}/users/${currentUserId}/redirects/${slug}`;
                        await deleteDoc(doc(db, docPath));
                        showMessage(`Link "${slug}" deleted successfully.`, 'success');
                    } catch (error) {
                        console.error("Error deleting link:", error);
                        showMessage("Failed to delete the link.", "error");
                    }
                }
            }
        }
        
        function toggleView(view) {
            if (view === 'analytics') {
                linksView.classList.add('hidden');
                analyticsView.classList.remove('hidden');
                showLinksBtn.classList.remove('border-indigo-500', 'text-indigo-600');
                showAnalyticsBtn.classList.add('border-indigo-500', 'text-indigo-600');
            } else {
                analyticsView.classList.add('hidden');
                linksView.classList.remove('hidden');
                showAnalyticsBtn.classList.remove('border-indigo-500', 'text-indigo-600');
                showLinksBtn.classList.add('border-indigo-500', 'text-indigo-600');
            }
        }

        function openLogModal(logData) {
            logDetailsContent.textContent = JSON.stringify(logData, null, 2);
            logModal.classList.remove('hidden');
            setTimeout(() => {
                modalOverlay.classList.remove('opacity-0');
                document.getElementById('modal-content').classList.remove('scale-95');
            }, 10);
        }

        function closeLogModal() {
            modalOverlay.classList.add('opacity-0');
            document.getElementById('modal-content').classList.add('scale-95');
            setTimeout(() => {
                logModal.classList.add('hidden');
            }, 300);
        }

        function copyToClipboard() {
            const textToCopy = shortLinkEl.href;
            const textArea = document.createElement("textarea");
            textArea.value = textToCopy;
            document.body.appendChild(textArea);
            textArea.select();
            try {
                document.execCommand('copy');
                copyFeedback.textContent = 'Copied!';
                setTimeout(() => { copyFeedback.textContent = ''; }, 2000);
            } catch (err) {
                copyFeedback.textContent = 'Failed to copy!';
                setTimeout(() => { copyFeedback.textContent = ''; }, 2000);
            }
            document.body.removeChild(textArea);
        }

        function setLoading(isLoading) {
            if (isLoading) {
                submitBtn.disabled = true;
                btnText.classList.add('hidden');
                btnLoader.classList.remove('hidden');
            } else {
                submitBtn.disabled = false;
                btnText.classList.remove('hidden');
                btnLoader.classList.add('hidden');
            }
        }

        function showMessage(message, type = 'info') {
            messageBox.textContent = message;
            messageBox.classList.remove('hidden', 'bg-red-100', 'text-red-700', 'bg-green-100', 'text-green-700');
            if (type === 'error') {
                messageBox.classList.add('bg-red-100', 'text-red-700');
            } else if (type === 'success') {
                messageBox.classList.add('bg-green-100', 'text-green-700');
            }
            setTimeout(() => {
                messageBox.classList.add('hidden');
            }, 5000);
        }

        // --- Event Listeners ---
        createLinkForm.addEventListener('submit', handleCreateLink);
        copyBtn.addEventListener('click', copyToClipboard);
        linksContainer.addEventListener('click', handleDeleteLink);
        showLinksBtn.addEventListener('click', () => toggleView('links'));
        showAnalyticsBtn.addEventListener('click', () => toggleView('analytics'));
        
        logsContainer.addEventListener('click', (e) => {
            const button = e.target.closest('.view-log-details-btn');
            if (button) {
                openLogModal(button._logData);
            }
        });

        closeModalBtn.addEventListener('click', closeLogModal);
        modalOverlay.addEventListener('click', closeLogModal);
        
        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
            baseUrlSpan.textContent = `${window.location.hostname}/`;
            initializeFirebase();
        });

    </script>
</body>
</html>

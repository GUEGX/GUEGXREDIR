<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>URL Redirector | Netlify & Firestore</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .gradient-bg { background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); }
        .card { background-color: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2); }
        .btn-primary { background-color: #4f46e5; transition: background-color 0.3s ease; }
        .btn-primary:hover { background-color: #4338ca; }
        .input-focus:focus { box-shadow: 0 0 0 2px #4f46e5; border-color: #4f46e5; }
        .log-table th { @apply px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider; }
        .log-table td { @apply px-4 py-3 whitespace-nowrap text-sm text-gray-700; }
        .modal-overlay { transition: opacity 0.3s ease; }
        .modal-content { transition: transform 0.3s ease; }
    </style>
</head>
<body class="gradient-bg min-h-screen flex items-center justify-center p-4">

    <!-- Login Overlay -->
    <div id="login-overlay" class="fixed inset-0 z-[100] bg-gray-900 bg-opacity-90 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full text-center">
            <h2 class="text-2xl font-bold text-gray-800 mb-2">Restricted Access</h2>
            <p class="text-gray-500 mb-6">Please enter the password to manage links.</p>
            <form id="login-form" class="space-y-4">
                <input type="password" id="password-input" placeholder="Password" 
                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow">
                <button type="submit" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700 transition duration-300">
                    Login
                </button>
                <p id="login-error" class="text-red-500 text-sm hidden">Incorrect password.</p>
            </form>
        </div>
    </div>

    <div id="app-container" class="w-full max-w-4xl mx-auto transition-opacity duration-500 opacity-0 filter blur-sm" aria-hidden="true">
        <div class="card rounded-2xl shadow-2xl p-6 md:p-10">
            <div class="text-center mb-8">
                <h1 class="text-3xl md:text-4xl font-bold text-gray-800">URL Redirector</h1>
                <p class="text-gray-500 mt-2">Create, manage, and analyze your short links.</p>
                <p class="text-xs text-gray-400 mt-1">Your User ID: <span id="userId" class="font-mono">loading...</span></p>
            </div>

            <!-- View Toggles -->
            <div class="flex justify-center border-b border-gray-200 mb-6">
                <button id="show-links-btn" class="px-4 py-2 -mb-px border-b-2 border-indigo-500 text-indigo-600 font-semibold">Manage Links</button>
                <button id="show-analytics-btn" class="px-4 py-2 text-gray-500 font-semibold hover:text-indigo-600">Analytics</button>
            </div>

            <!-- Main Content Area -->
            <div id="main-content">
                <!-- Links Management View -->
                <div id="links-view">
                    <!-- Form to create a new link -->
                    <div id="create-section">
                        <h2 class="text-xl font-semibold text-gray-700 mb-4">Create a New Short Link</h2>
                        <form id="create-link-form" class="space-y-4">
                           <div>
                                <label for="longUrl" class="block text-sm font-medium text-gray-600 mb-1">Original URL</label>
                                <input type="url" id="longUrl" placeholder="https://your-long-url.com" required
                                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none input-focus transition-shadow">
                            </div>
                            <div>
                                <label for="customSlug" class="block text-sm font-medium text-gray-600 mb-1">Custom Slug (Optional)</label>
                                <div class="flex">
                                   <span class="inline-flex items-center px-3 text-sm text-gray-500 bg-gray-100 border border-r-0 border-gray-300 rounded-l-md">
                                        <span id="base-url">your-site.netlify.app/</span>
                                   </span>
                                   <input type="text" id="customSlug" placeholder="my-custom-link"
                                          class="w-full px-4 py-2 border border-gray-300 rounded-r-lg focus:outline-none input-focus transition-shadow"
                                          pattern="[a-zA-Z0-9-]+" title="Only letters, numbers, and hyphens are allowed.">
                                </div>
                            </div>

                            <!-- Social Media Preview Section -->
                            <div class="pt-2">
                                <button type="button" id="toggle-social-btn" class="flex items-center text-sm font-semibold text-indigo-600 hover:text-indigo-800 focus:outline-none">
                                    <svg class="w-4 h-4 mr-1 transition-transform duration-200" id="social-arrow" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                                    Customize Social Preview (OG Tags)
                                </button>
                                <div id="social-section" class="hidden mt-3 space-y-3 pl-2 border-l-2 border-indigo-100">
                                    <div>
                                        <label for="ogTitle" class="block text-xs font-medium text-gray-500 mb-1">Title</label>
                                        <input type="text" id="ogTitle" placeholder="My Awesome Link"
                                               class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:outline-none input-focus">
                                    </div>
                                    <div>
                                        <label for="ogDescription" class="block text-xs font-medium text-gray-500 mb-1">Description</label>
                                        <input type="text" id="ogDescription" placeholder="Click to see more..."
                                               class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:outline-none input-focus">
                                    </div>
                                    <div>
                                        <label for="ogImage" class="block text-xs font-medium text-gray-500 mb-1">Image URL</label>
                                        <input type="url" id="ogImage" placeholder="https://example.com/image.jpg"
                                               class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:outline-none input-focus">
                                        <p class="text-[10px] text-gray-400 mt-1">Use a large image (1200x630) for best results on Twitter/X.</p>
                                    </div>
                                </div>
                            </div>

                            <button type="submit" id="submit-btn" class="w-full btn-primary text-white font-semibold py-2.5 px-4 rounded-lg shadow-md">
                                <span id="btn-text">Shorten URL</span>
                                <span id="btn-loader" class="hidden">
                                    <svg class="animate-spin h-5 w-5 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                    </svg>
                                </span>
                            </button>
                        </form>
                    </div>

                    <!-- Display generated link -->
                    <div id="result-section" class="hidden mt-6 text-center p-4 bg-indigo-50 rounded-lg border border-indigo-200">
                        <p class="text-gray-700">Your short link is ready!</p>
                        <div class="flex items-center justify-center mt-2">
                            <a id="short-link" href="#" target="_blank" class="text-indigo-600 font-mono text-lg hover:underline"></a>
                            <button id="copy-btn" class="ml-4 p-2 text-gray-500 hover:text-indigo-600 rounded-full hover:bg-indigo-100 transition">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
                            </button>
                        </div>
                        <p id="copy-feedback" class="text-sm text-green-600 mt-1 h-4"></p>
                    </div>

                    <!-- Message box for errors or info -->
                    <div id="message-box" class="hidden mt-4 p-3 text-center text-sm rounded-lg"></div>

                    <!-- List of existing links -->
                    <div class="mt-10">
                        <h2 class="text-xl font-semibold text-gray-700 mb-4">Your Links</h2>
                        <div id="links-container" class="space-y-3">
                            <p id="no-links-msg" class="text-gray-500 text-center py-4">You haven't created any links yet.</p>
                            <div id="links-loader" class="text-center py-4">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Analytics View -->
                <div id="analytics-view" class="hidden">
                    <h2 class="text-xl font-semibold text-gray-700 mb-4">Click Analytics</h2>
                    <div class="overflow-x-auto bg-white rounded-lg shadow">
                       <table class="min-w-full divide-y divide-gray-200 log-table">
                           <thead class="bg-gray-50">
                               <tr>
                                   <th>Timestamp</th>
                                   <th>Slug</th>
                                   <th>Country</th>
                                   <th>Referrer</th>
                                   <th>Details</th>
                               </tr>
                           </thead>
                           <tbody id="logs-container" class="divide-y divide-gray-200">
                           </tbody>
                       </table>
                    </div>
                     <p id="no-logs-msg" class="hidden text-gray-500 text-center py-8">No click data available yet.</p>
                     <div id="logs-loader" class="text-center py-8">
                        <svg class="animate-spin h-8 w-8 text-indigo-500 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                     </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Log Details Modal -->
    <div id="log-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden">
        <div id="modal-overlay" class="modal-overlay absolute inset-0 bg-black bg-opacity-50"></div>
        <div id="modal-content" class="modal-content bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-full overflow-y-auto transform scale-95">
            <div class="p-6">
                <div class="flex justify-between items-center border-b pb-3">
                    <h3 class="text-xl font-semibold text-gray-800">Log Details</h3>
                    <button id="close-modal-btn" class="p-2 rounded-full hover:bg-gray-200">
                        <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>
                <div class="mt-4">
                    <pre id="log-details-content" class="text-sm bg-gray-100 p-4 rounded-md overflow-x-auto"></pre>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Confirmation Modal -->
    <div id="confirm-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden">
        <div class="absolute inset-0 bg-black bg-opacity-50"></div>
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md transform scale-95">
            <div class="p-6">
                <h3 id="confirm-title" class="text-lg font-medium text-gray-900">Are you sure?</h3>
                <div class="mt-2">
                    <p id="confirm-text" class="text-sm text-gray-500">This action cannot be undone.</p>
                </div>
                <div class="mt-5 sm:mt-6 sm:grid sm:grid-cols-2 sm:gap-3 sm:grid-flow-row-dense">
                    <button id="confirm-yes-btn" type="button" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 focus:outline-none sm:col-start-2 sm:text-sm">
                        Confirm
                    </button>
                    <button id="confirm-no-btn" type="button" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none sm:mt-0 sm:col-start-1 sm:text-sm">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, onSnapshot, deleteDoc, setLogLevel, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        document.addEventListener('DOMContentLoaded', () => {
            // --- Firebase Configuration and Initialization ---
            // It's recommended to move these to environment variables for production
            const firebaseConfig = {
                apiKey: "AIzaSyCc2Em_b5oe1bGtQzcAlhYzqSnlAGfQt-0",
                authDomain: "guegxredir.firebaseapp.com",
                projectId: "guegxredir",
                storageBucket: "guegxredir.appspot.com",
                messagingSenderId: "1086770860900",
                appId: "1:1086770860900:web:929a76665e66a5e36f6071",
                measurementId: "G-4FLDMRLXVN"
            };
            
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

            let app, db, auth, currentUserId;
            let logsUnsubscribe = null; 

            // --- UI Element References ---
            const showLinksBtn = document.getElementById('show-links-btn');
            const showAnalyticsBtn = document.getElementById('show-analytics-btn');
            const linksView = document.getElementById('links-view');
            const analyticsView = document.getElementById('analytics-view');
            const logsContainer = document.getElementById('logs-container');
            const noLogsMsg = document.getElementById('no-logs-msg');
            const logsLoader = document.getElementById('logs-loader');
            const logModal = document.getElementById('log-modal');
            const modalOverlay = document.getElementById('modal-overlay');
            const closeModalBtn = document.getElementById('close-modal-btn');
            const logDetailsContent = document.getElementById('log-details-content');
            const createLinkForm = document.getElementById('create-link-form');
            const longUrlInput = document.getElementById('longUrl');
            const customSlugInput = document.getElementById('customSlug');
            const ogTitleInput = document.getElementById('ogTitle');
            const ogDescriptionInput = document.getElementById('ogDescription');
            const ogImageInput = document.getElementById('ogImage');
            const toggleSocialBtn = document.getElementById('toggle-social-btn');
            const socialSection = document.getElementById('social-section');
            const socialArrow = document.getElementById('social-arrow');
            const submitBtn = document.getElementById('submit-btn');
            const btnText = document.getElementById('btn-text');
            const btnLoader = document.getElementById('btn-loader');
            const resultSection = document.getElementById('result-section');
            const shortLinkEl = document.getElementById('short-link');
            const copyBtn = document.getElementById('copy-btn');
            const copyFeedback = document.getElementById('copy-feedback');
            const messageBox = document.getElementById('message-box');
            const linksContainer = document.getElementById('links-container');
            const noLinksMsg = document.getElementById('no-links-msg');
            const linksLoader = document.getElementById('links-loader');
            const userIdSpan = document.getElementById('userId');
            const baseUrlSpan = document.getElementById('base-url');
            const confirmModal = document.getElementById('confirm-modal');
            const confirmYesBtn = document.getElementById('confirm-yes-btn');
            const confirmNoBtn = document.getElementById('confirm-no-btn');
            const confirmTitle = document.getElementById('confirm-title');
            const confirmText = document.getElementById('confirm-text');


            // --- Main Application Logic ---

            async function initializeFirebase() {
                if (!firebaseConfig.apiKey) {
                    console.error("Firebase config is missing.");
                    showMessage("Configuration error. App cannot start.", "error");
                    return;
                }
                try {
                    app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);
                    // setLogLevel('debug'); // Uncomment for verbose Firestore logs
                    setupAuthListener();
                } catch (error) {
                    console.error("Firebase initialization failed:", error);
                    showMessage("Failed to initialize the application.", "error");
                }
            }

            function setupAuthListener() {
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        currentUserId = user.uid;
                        userIdSpan.textContent = currentUserId;
                        console.log("User is signed in with UID:", currentUserId);
                        await setupRealtimeListeners();
                    } else {
                        console.log("User is not signed in. Attempting to sign in.");
                        await signIn();
                    }
                });
            }
            
            async function signIn() {
                 try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                        console.log("Signed in with custom token.");
                    } else {
                        await signInAnonymously(auth);
                        console.log("Signed in anonymously.");
                    }
                } catch (error) {
                    console.error("Authentication failed:", error);
                    showMessage(error.message, "error");
                }
            }

            async function setupRealtimeListeners() {
                if (!currentUserId) return;
                
                // Listener for user's redirect links
                const linksCollectionPath = `/artifacts/${appId}/users/${currentUserId}/redirects`;
                onSnapshot(collection(db, linksCollectionPath), (snapshot) => {
                    linksLoader.classList.add('hidden');
                    displayLinks(snapshot.docs);
                }, (error) => {
                    console.error("Error fetching links:", error);
                    showMessage("Could not load your links.", "error");
                });

                // Listener for user's logs
                const logsCollectionPath = `/artifacts/${appId}/users/${currentUserId}/logs`;
                const logsQuery = query(collection(db, logsCollectionPath)); // Removed orderBy

                if (logsUnsubscribe) logsUnsubscribe(); 
                
                logsUnsubscribe = onSnapshot(logsQuery, (snapshot) => {
                    logsLoader.classList.add('hidden');
                    // Sort logs by timestamp client-side (newest first)
                    const sortedDocs = snapshot.docs.sort((a, b) => {
                        const timeA = a.data().timestamp;
                        const timeB = b.data().timestamp;
                        return new Date(timeB) - new Date(timeA);
                    });
                    displayLogs(sortedDocs);
                }, (error) => {
                    console.error("Error fetching logs:", error);
                    showMessage("Could not load analytics data.", "error");
                });
            }

            function displayLinks(docs) {
                // Clear existing links except for the loader/message
                linksContainer.innerHTML = '';
                linksContainer.appendChild(noLinksMsg);
                linksContainer.appendChild(linksLoader);
                
                noLinksMsg.classList.toggle('hidden', docs.length > 0);

                docs.forEach(doc => {
                    const slug = doc.id;
                    const data = doc.data();
                    const linkItem = document.createElement('div');
                    linkItem.className = 'link-item flex items-center justify-between p-3 bg-white border rounded-lg shadow-sm';
                    linkItem.dataset.slug = slug;
                    
                    const shortUrl = `${window.location.origin}/${slug}`;
                    linkItem.innerHTML = `
                        <div class="flex-grow overflow-hidden mr-4">
                            <a href="${shortUrl}" target="_blank" class="font-semibold text-indigo-700 truncate hover:underline">${shortUrl}</a>
                            <p class="text-sm text-gray-500 truncate" title="${data.longUrl}">${data.longUrl}</p>
                        </div>
                        <div class="flex-shrink-0 flex items-center space-x-2">
                            <span class="text-sm font-medium text-gray-600">${data.clickCount || 0} Clicks</span>
                            <button class="delete-btn p-2 text-gray-400 hover:text-red-600 hover:bg-red-100 rounded-full transition" data-slug="${slug}" data-url="${shortUrl}">
                                 <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                            </button>
                        </div>
                    `;
                    linksContainer.appendChild(linkItem);
                });
            }

            function displayLogs(docs) {
                logsContainer.innerHTML = '';
                noLogsMsg.classList.toggle('hidden', docs.length > 0);

                if (docs.length === 0) return;

                docs.forEach(doc => {
                    const logData = doc.data();
                    const tr = document.createElement('tr');
                    tr.className = "hover:bg-gray-50";
                    
                    const formattedDate = new Date(logData.timestamp).toLocaleString();

                    tr.innerHTML = `
                        <td>${formattedDate}</td>
                        <td>/${logData.slug}</td>
                        <td>${logData.geolocation?.country || 'N/A'}</td>
                        <td class="truncate max-w-xs">${logData.referrer || 'Direct'}</td>
                        <td>
                            <button class="view-log-details-btn text-indigo-600 hover:text-indigo-900 font-medium" data-log-id="${doc.id}">
                                View
                            </button>
                        </td>
                    `;
                    tr.querySelector('.view-log-details-btn')._logData = logData; // Attach data directly to the element
                    logsContainer.appendChild(tr);
                });
            }

            async function handleCreateLink(e) {
                e.preventDefault();
                setLoading(true);

                const longUrl = longUrlInput.value;
                const customSlug = customSlugInput.value.trim();
                const ogTitle = ogTitleInput.value.trim();
                const ogDescription = ogDescriptionInput.value.trim();
                const ogImage = ogImageInput.value.trim();

                try {
                    const response = await fetch('/.netlify/functions/create-link', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            longUrl, 
                            customSlug, 
                            userId: currentUserId, 
                            appId,
                            ogTitle,
                            ogDescription,
                            ogImage
                        }),
                    });
                    const data = await response.json();
                    if (!response.ok) throw new Error(data.error || 'An error occurred.');

                    const fullShortUrl = `${window.location.origin}/${data.slug}`;
                    shortLinkEl.href = fullShortUrl;
                    shortLinkEl.textContent = fullShortUrl;
                    resultSection.classList.remove('hidden');
                    showMessage(`Successfully created link!`, 'success');
                    createLinkForm.reset();
                } catch (error) {
                    console.error('Error creating link:', error);
                    showMessage(error.message, 'error');
                } finally {
                    setLoading(false);
                }
            }

            function handleDeleteLink(e) {
                 const deleteButton = e.target.closest('.delete-btn');
                 if (deleteButton) {
                    const slug = deleteButton.dataset.slug;
                    const url = deleteButton.dataset.url;
                    
                    showConfirmationModal(
                        `Delete Link?`,
                        `Are you sure you want to delete the link for "${url}"? This cannot be undone.`,
                        async () => {
                            try {
                                const docPath = `/artifacts/${appId}/users/${currentUserId}/redirects/${slug}`;
                                await deleteDoc(doc(db, docPath));
                                showMessage(`Link "${slug}" deleted successfully.`, 'success');
                            } catch (error) {
                                console.error("Error deleting link:", error);
                                showMessage("Failed to delete the link.", "error");
                            }
                        }
                    );
                }
            }
            
            function toggleView(view) {
                if (view === 'analytics') {
                    linksView.classList.add('hidden');
                    analyticsView.classList.remove('hidden');
                    showLinksBtn.classList.remove('border-indigo-500', 'text-indigo-600');
                    showAnalyticsBtn.classList.add('border-indigo-500', 'text-indigo-600');
                } else {
                    analyticsView.classList.add('hidden');
                    linksView.classList.remove('hidden');
                    showAnalyticsBtn.classList.remove('border-indigo-500', 'text-indigo-600');
                    showLinksBtn.classList.add('border-indigo-500', 'text-indigo-600');
                }
            }

            function openLogModal(logData) {
                logDetailsContent.textContent = JSON.stringify(logData, null, 2);
                logModal.classList.remove('hidden');
                setTimeout(() => {
                    modalOverlay.classList.remove('opacity-0');
                    document.getElementById('modal-content').classList.remove('scale-95');
                }, 10);
            }

            function closeLogModal() {
                modalOverlay.classList.add('opacity-0');
                document.getElementById('modal-content').classList.add('scale-95');
                setTimeout(() => {
                    logModal.classList.add('hidden');
                }, 300);
            }
            
            function showConfirmationModal(title, text, onConfirm) {
                confirmTitle.textContent = title;
                confirmText.textContent = text;
                
                const confirmHandler = () => {
                    onConfirm();
                    closeConfirmationModal();
                };

                const cancelHandler = () => {
                    closeConfirmationModal();
                };

                const closeConfirmationModal = () => {
                    confirmModal.classList.add('hidden');
                    confirmYesBtn.removeEventListener('click', confirmHandler);
                    confirmNoBtn.removeEventListener('click', cancelHandler);
                };

                confirmYesBtn.addEventListener('click', confirmHandler, { once: true });
                confirmNoBtn.addEventListener('click', cancelHandler, { once: true });
                
                confirmModal.classList.remove('hidden');
            }

            function copyToClipboard() {
                const textToCopy = shortLinkEl.href;
                // Use the modern clipboard API if available, with a fallback
                if (navigator.clipboard) {
                    navigator.clipboard.writeText(textToCopy).then(() => {
                        copyFeedback.textContent = 'Copied!';
                        setTimeout(() => { copyFeedback.textContent = ''; }, 2000);
                    }).catch(err => {
                        copyFeedback.textContent = 'Failed to copy!';
                        setTimeout(() => { copyFeedback.textContent = ''; }, 2000);
                    });
                } else { // Fallback for older browsers
                    const textArea = document.createElement("textarea");
                    textArea.value = textToCopy;
                    document.body.appendChild(textArea);
                    textArea.select();
                    try {
                        document.execCommand('copy');
                        copyFeedback.textContent = 'Copied!';
                    } catch (err) {
                        copyFeedback.textContent = 'Failed to copy!';
                    }
                    setTimeout(() => { copyFeedback.textContent = ''; }, 2000);
                    document.body.removeChild(textArea);
                }
            }

            function setLoading(isLoading) {
                submitBtn.disabled = isLoading;
                btnText.classList.toggle('hidden', isLoading);
                btnLoader.classList.toggle('hidden', !isLoading);
            }

            function showMessage(message, type = 'info') {
                messageBox.textContent = message;
                messageBox.className = 'mt-4 p-3 text-center text-sm rounded-lg'; // Reset classes
                if (type === 'error') {
                    messageBox.classList.add('bg-red-100', 'text-red-700');
                } else if (type === 'success') {
                    messageBox.classList.add('bg-green-100', 'text-green-700');
                }
                setTimeout(() => {
                    messageBox.classList.add('hidden');
                }, 5000);
            }

            // --- Event Listeners ---
            toggleSocialBtn.addEventListener('click', () => {
                socialSection.classList.toggle('hidden');
                socialArrow.classList.toggle('rotate-90');
            });

            createLinkForm.addEventListener('submit', handleCreateLink);
            copyBtn.addEventListener('click', copyToClipboard);
            linksContainer.addEventListener('click', handleDeleteLink);
            showLinksBtn.addEventListener('click', () => toggleView('links'));
            showAnalyticsBtn.addEventListener('click', () => toggleView('analytics'));
            
            logsContainer.addEventListener('click', (e) => {
                const button = e.target.closest('.view-log-details-btn');
                if (button && button._logData) {
                    openLogModal(button._logData);
                }
            });

            closeModalBtn.addEventListener('click', closeLogModal);
            modalOverlay.addEventListener('click', closeLogModal);
            
            // --- Simple Authentication Logic ---
            const loginOverlay = document.getElementById('login-overlay');
            const appContainer = document.getElementById('app-container');
            const loginForm = document.getElementById('login-form');
            const passwordInput = document.getElementById('password-input');
            const loginError = document.getElementById('login-error');

            // SHA-256 Hash of 'admin'
            const PASSWORD_HASH = '8c6976e5b5410415bde908bd4dee15dfb167a9c873fc4bb8a81f6f2ab448a918';

            async function hashString(str) {
                const msgBuffer = new TextEncoder().encode(str);
                const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
                const hashArray = Array.from(new Uint8Array(hashBuffer));
                return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            }

            async function checkSession() {
                const storedHash = sessionStorage.getItem('auth_hash');
                if (storedHash === PASSWORD_HASH) {
                    showApp();
                }
            }

            function showApp() {
                loginOverlay.classList.add('hidden');
                appContainer.classList.remove('opacity-0', 'blur-sm');
                appContainer.removeAttribute('aria-hidden');
            }

            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const input = passwordInput.value;
                const hash = await hashString(input);
                
                if (hash === PASSWORD_HASH) {
                    sessionStorage.setItem('auth_hash', hash);
                    showApp();
                    loginError.classList.add('hidden');
                } else {
                    loginError.classList.remove('hidden');
                    passwordInput.value = '';
                    passwordInput.focus();
                }
            });

            checkSession();

            // --- Initial Load ---
            baseUrlSpan.textContent = `${window.location.hostname}/`;
            initializeFirebase();
        });

    </script>
</body>
</html>
